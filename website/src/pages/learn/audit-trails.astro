---
import '../../styles/global.css';
import Navbar from '../../components/Navbar.astro';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Audit Trails â€” NL Protocol</title>
    <meta name="description" content="Learn how the Never-Leak Protocol creates tamper-evident, cryptographically chained audit records for every agent action. Understand hash chains, HMAC signing, and verification." />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  </head>
  <body class="min-h-screen overflow-x-hidden">
    <Navbar current="learn" />
    <main class="pt-20 pb-20">

      <!-- Back link -->
      <div class="mx-auto max-w-3xl px-4 sm:px-6 mb-8">
        <a href="/learn" class="text-sm text-nl-text-tertiary hover:text-nl-text-secondary transition-colors">
          &larr; Back to Learn
        </a>
      </div>

      <!-- Header -->
      <div class="mx-auto max-w-3xl px-4 sm:px-6 mb-12">
        <div class="flex items-center gap-3 mb-4">
          <span class="pill" style="border-color: rgba(34,197,94,0.2); color: #22C55E; background: rgba(34,197,94,0.05);">Concept</span>
          <span class="text-xs text-nl-text-tertiary font-mono">5 min read</span>
        </div>
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-4 leading-tight">
          Audit Trails: <span class="text-nl-green">Tamper-Evident Records</span> for Every Action
        </h1>
        <p class="text-nl-text-secondary leading-relaxed">
          The NL Protocol creates an immutable, cryptographically chained audit log for every secret access, delegation, and revocation. If even one record is modified, the entire chain breaks -- making tampering mathematically detectable.
        </p>
      </div>

      <!-- Section 1: Why Traditional Logs Fail -->
      <section class="mx-auto max-w-3xl px-4 sm:px-6 mb-12">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-nl-text">Why Traditional Logs Fail</h2>
        <div class="text-nl-text-secondary leading-relaxed space-y-4">
          <p>
            Most logging systems are <strong class="text-nl-text">mutable</strong>. Log files can be edited, entries can be deleted, timestamps can be altered. An attacker who gains access to a system can cover their tracks by modifying or removing the log entries that document their actions.
          </p>
          <p>
            For traditional applications, this risk is manageable with log aggregation and access controls. But for AI agent security, the stakes are different. An agent that has been compromised through prompt injection might attempt thousands of secret accesses in seconds. If the audit trail can be tampered with, there is no way to reconstruct what happened, which secrets were accessed, or whether data was exfiltrated.
          </p>
          <p>
            What you need is not just logging, but <strong class="text-nl-text">mathematical proof</strong> that the log has not been tampered with.
          </p>
        </div>
      </section>

      <!-- Section 2: How NL Protocol Audit Works -->
      <section class="mx-auto max-w-3xl px-4 sm:px-6 mb-12">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-nl-text">How NL Protocol Audit Works</h2>
        <div class="text-nl-text-secondary leading-relaxed space-y-4 mb-6">
          <p>
            Every action in the NL Protocol creates an <strong class="text-nl-text">audit record</strong>. This record captures the agent's identity, the action type, which secrets were referenced (by name, never by value), a timestamp, and a summary of the result.
          </p>
          <p>
            What makes these records tamper-evident is how they are chained together. Each record includes a <strong class="text-nl-text">SHA-256 hash</strong> of the previous record. This creates a <strong class="text-nl-text">hash chain</strong> -- a sequence where each entry depends on all the entries before it. Changing any single record would change its hash, which would break the link to the next record, which would break the link after that, and so on.
          </p>
          <p>
            Additionally, each record is <strong class="text-nl-text">HMAC-signed</strong> using a secret key held by the NL System. This means that not only is the chain order protected, but each individual record is authenticated. You cannot forge a new record or modify an existing one without the signing key.
          </p>
        </div>

        <div class="code-block p-4 sm:p-5">
          <div class="text-nl-text-tertiary text-xs mb-3 font-mono uppercase tracking-widest">Audit Record Structure</div>
          <pre class="text-xs sm:text-sm leading-relaxed">{`{
  `}<span class="string">"sequence"</span>: <span class="keyword">42</span>,
  <span class="string">"timestamp"</span>: <span class="string">"2026-02-09T10:30:00Z"</span>,
  <span class="string">"agent_id"</span>: <span class="string">"nl://deploy/orchestrator"</span>,
  <span class="string">"action_type"</span>: <span class="string">"exec"</span>,
  <span class="string">"secrets_used"</span>: [<span class="string">"production/db-password"</span>],
  <span class="string">"result_summary"</span>: <span class="string">"exit_code: 0, stdout: 142 bytes"</span>,
  <span class="string">"prev_hash"</span>: <span class="string">"sha256:a1b2c3d4e5f6..."</span>,
  <span class="string">"hmac"</span>: <span class="string">"hmac-sha256:f6e5d4c3b2a1..."</span>
{`}`}</pre>
        </div>

        <p class="text-sm text-nl-text-tertiary mt-3">
          Note: the <code class="text-nl-cyan font-mono text-xs">secrets_used</code> field records secret <em>names</em>, not values. The audit trail documents which secrets were accessed, without ever containing the secret data itself.
        </p>
      </section>

      <!-- Section 3: Visualize the Chain -->
      <section class="mx-auto max-w-3xl px-4 sm:px-6 mb-12">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-nl-text">The Hash Chain</h2>
        <p class="text-nl-text-secondary leading-relaxed mb-6">
          Each record's hash is computed over its entire contents <em>including</em> the hash of the previous record. This creates an unbreakable chain where modifying any record invalidates everything that follows.
        </p>

        <div class="code-block p-4 sm:p-5">
          <div class="text-nl-text-tertiary text-xs mb-3 font-mono uppercase tracking-widest">Hash Chain Visualization</div>
          <pre class="text-xs sm:text-sm leading-relaxed">
<span class="function">+----------------+</span>     <span class="function">+----------------+</span>     <span class="function">+----------------+</span>
<span class="function">|</span>  <span class="string">Record #40</span>     <span class="function">|</span>     <span class="function">|</span>  <span class="string">Record #41</span>     <span class="function">|</span>     <span class="function">|</span>  <span class="string">Record #42</span>     <span class="function">|</span>
<span class="function">|</span>                <span class="function">|</span>     <span class="function">|</span>                <span class="function">|</span>     <span class="function">|</span>                <span class="function">|</span>
<span class="function">|</span>  agent: ...    <span class="function">|</span>     <span class="function">|</span>  agent: ...    <span class="function">|</span>     <span class="function">|</span>  agent: ...    <span class="function">|</span>
<span class="function">|</span>  action: exec  <span class="function">|</span>     <span class="function">|</span>  action: exec  <span class="function">|</span>     <span class="function">|</span>  action: exec  <span class="function">|</span>
<span class="function">|</span>  prev: <span class="placeholder">hash39</span>  <span class="function">|</span>--&gt;  <span class="function">|</span>  prev: <span class="placeholder">hash40</span>  <span class="function">|</span>--&gt;  <span class="function">|</span>  prev: <span class="placeholder">hash41</span>  <span class="function">|</span>--&gt; ...
<span class="function">|</span>  <span class="keyword">HMAC signed</span>   <span class="function">|</span>     <span class="function">|</span>  <span class="keyword">HMAC signed</span>   <span class="function">|</span>     <span class="function">|</span>  <span class="keyword">HMAC signed</span>   <span class="function">|</span>
<span class="function">+----------------+</span>     <span class="function">+----------------+</span>     <span class="function">+----------------+</span></pre>
        </div>

        <div class="glass-card p-5 mt-6">
          <div class="flex items-start gap-3">
            <span class="text-nl-amber mt-0.5 shrink-0 text-lg">!</span>
            <p class="text-sm text-nl-text-secondary leading-relaxed">
              <strong class="text-nl-text">If Record #41 is modified</strong>, its hash changes. This means Record #42's <code class="text-nl-cyan font-mono text-xs">prev_hash</code> no longer matches, breaking the chain. The tampering is immediately detectable by any verifier.
            </p>
          </div>
        </div>
      </section>

      <!-- Section 4: What Gets Recorded -->
      <section class="mx-auto max-w-3xl px-4 sm:px-6 mb-12">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-nl-text">What Gets Recorded</h2>
        <p class="text-nl-text-secondary leading-relaxed mb-6">
          The audit trail captures every security-relevant event in the system. Nothing happens silently.
        </p>

        <div class="glass-card p-6">
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <div class="font-semibold text-nl-text mb-2 text-sm">Secret Access</div>
              <ul class="space-y-1.5">
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Every action request and response
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Which secrets were resolved
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Sanitization events (leaked values detected)
                </li>
              </ul>
            </div>
            <div>
              <div class="font-semibold text-nl-text mb-2 text-sm">Delegation</div>
              <ul class="space-y-1.5">
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Token creation and scope details
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Token usage by sub-agents
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Revocations and cascade events
                </li>
              </ul>
            </div>
            <div>
              <div class="font-semibold text-nl-text mb-2 text-sm">Access Control</div>
              <ul class="space-y-1.5">
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Scope grant creation and modification
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Denied requests (with reason)
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Grant exhaustion (max_uses reached)
                </li>
              </ul>
            </div>
            <div>
              <div class="font-semibold text-nl-text mb-2 text-sm">Threat Detection</div>
              <ul class="space-y-1.5">
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Anomaly detection triggers
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Prompt injection detection events
                </li>
                <li class="flex items-start gap-2 text-sm text-nl-text-secondary">
                  <span class="text-nl-green mt-0.5 shrink-0">&#x2713;</span>
                  Automated response actions taken
                </li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- Section 5: Verification -->
      <section class="mx-auto max-w-3xl px-4 sm:px-6 mb-12">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-nl-text">Verification</h2>
        <div class="text-nl-text-secondary leading-relaxed space-y-4">
          <p>
            Anyone with read access to the audit log can verify its integrity. The process is straightforward: start from the first record, compute its SHA-256 hash, check that the next record's <code class="text-nl-cyan font-mono text-xs">prev_hash</code> field matches, and repeat for every record in the chain.
          </p>
          <p>
            If even one bit of any record has been changed -- a modified timestamp, an altered agent ID, a deleted entry -- the hash chain will break at that point. The verification tool will report exactly where the discrepancy occurred.
          </p>
        </div>

        <div class="mt-6">
          <div class="code-block p-4 sm:p-5">
            <div class="text-nl-text-tertiary text-xs mb-3 font-mono uppercase tracking-widest">Verification Algorithm</div>
            <pre class="text-xs sm:text-sm leading-relaxed"><span class="keyword">function</span> <span class="function">verify_chain</span>(records):
    <span class="keyword">for</span> i <span class="keyword">in</span> range(1, len(records)):
        expected_hash = <span class="function">sha256</span>(records[i - 1])
        <span class="keyword">if</span> records[i].prev_hash != expected_hash:
            <span class="keyword">return</span> <span class="string">"TAMPERED at record"</span>, i

        <span class="keyword">if not</span> <span class="function">verify_hmac</span>(records[i], signing_key):
            <span class="keyword">return</span> <span class="string">"FORGED record at"</span>, i

    <span class="keyword">return</span> <span class="string">"CHAIN VALID"</span>, len(records), <span class="string">"records verified"</span></pre>
          </div>
        </div>
      </section>

      <!-- Section 6: Foundational Role -->
      <section class="mx-auto max-w-3xl px-4 sm:px-6 mb-16">
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-nl-text">The Foundation for Higher Levels</h2>
        <div class="text-nl-text-secondary leading-relaxed space-y-4 mb-6">
          <p>
            Audit integrity (Level 5 of the protocol) is not just a nice-to-have -- it is the <strong class="text-nl-text">foundation</strong> for the two highest security levels: Attack Detection (Level 6) and Cross-Agent Trust (Level 7).
          </p>
          <p>
            Attack detection relies on analyzing audit records to identify anomalous patterns: unusual access frequency, unexpected secrets being accessed, or actions that don't match an agent's historical behavior. If the audit trail can be tampered with, attackers can erase the evidence of their anomalous behavior.
          </p>
          <p>
            Cross-agent trust relies on audit records to verify that delegation chains are valid and that agents have behaved correctly. If audit integrity fails, trust verification becomes unreliable.
          </p>
        </div>

        <div class="glass-card p-5">
          <div class="flex items-start gap-3">
            <span class="text-nl-amber mt-0.5 shrink-0 text-lg">!</span>
            <p class="text-sm text-nl-text-secondary leading-relaxed">
              <strong class="text-nl-text">Fail-closed behavior:</strong> If audit chain verification fails, Levels 6 and 7 automatically enter a fail-closed state. Attack detection assumes all activity is suspicious, and cross-agent delegation is suspended. This ensures that a compromised audit trail cannot be used to mask ongoing attacks.
            </p>
          </div>
        </div>
      </section>

      <!-- Navigation -->
      <div class="mx-auto max-w-3xl px-4 sm:px-6">
        <div class="border-t border-nl-border pt-8 flex items-center justify-between">
          <a href="/learn/delegation-tokens" class="text-sm text-nl-cyan hover:text-nl-cyan/80 transition-colors font-medium">
            &larr; Delegation Tokens
          </a>
          <a href="/learn" class="text-sm text-nl-text-tertiary hover:text-nl-text-secondary transition-colors">
            Back to Learn &rarr;
          </a>
        </div>
      </div>

    </main>
    <footer class="border-t border-nl-border py-8">
      <div class="mx-auto max-w-4xl px-4 sm:px-6 flex flex-col sm:flex-row items-center justify-between gap-2 text-xs sm:text-sm text-nl-text-tertiary">
        <span>Never-Leak Protocol v1.0</span>
        <span class="inline-flex items-center gap-2">Created by <a href="https://braincol.com" class="inline-flex items-center gap-1.5 text-nl-text-secondary hover:text-nl-text transition-colors"><img src="/braincol-logo.svg" alt="" class="h-4 w-4" />Braincol</a></span>
      </div>
    </footer>
  </body>
</html>
